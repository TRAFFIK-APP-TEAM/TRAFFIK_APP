<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:views="clr-namespace:TRAFFIK_APP.Views"
             x:Class="TRAFFIK_APP.Views.DashboardPage"
             xmlns:viewmodels="clr-namespace:TRAFFIK_APP.ViewModels"
             BackgroundColor="#000000"
             Shell.TabBarIsVisible="False"
             Title="Dashboard">

    <Grid RowDefinitions="Auto,*,Auto">

        <!-- Main Content -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Padding="24" Spacing="24">

                <!-- Greeting -->
                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                    <Label Grid.Row="0" Text="Welcome back," FontSize="18" TextColor="White" />
                    <Label Grid.Row="1" Text="{Binding UserFullName}" FontSize="24" FontAttributes="Bold" TextColor="White" />
                    <ImageButton Grid.Row="0" Grid.RowSpan="2" Grid.Column="1"
                                 Source="bell_icon.png"
                                 BackgroundColor="Transparent"
                                 HeightRequest="24"
                                 WidthRequest="24"
                                 VerticalOptions="Center"
                                 Clicked="OnNotificationClicked" />
                </Grid>

                <!-- Rewards -->
                <VerticalStackLayout Padding="16" Spacing="20">

                    <!-- Points Display -->
                    <Label Text="{Binding RewardBalance, StringFormat='Your Points: {0}'}"
           FontSize="18"
           FontAttributes="Bold"
           TextColor="White" />

                    <!-- Available Rewards (Top 3) -->
                    <Label Text="Available Rewards" FontSize="16" TextColor="White" />
                    <CollectionView ItemsSource="{Binding TopAvailableRewards}" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <VerticalStackLayout Padding="10" BackgroundColor="#1E1E1E" Margin="0,0,0,10">
                                    <Label Text="{Binding Name}" TextColor="White" FontSize="14" FontAttributes="Bold"/>
                                    <Label Text="{Binding Description}" TextColor="#C8C8C8" FontSize="12"/>
                                    <Label Text="{Binding Cost, StringFormat='Cost: {0} pts'}" TextColor="#007AFF" FontSize="12"/>
                                    <Button Text="Redeem"
                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:RewardsViewModel}}, Path=RedeemCommand}"
                            CommandParameter="{Binding}"
                            BackgroundColor="#007AFF"
                            TextColor="White"
                            CornerRadius="8"
                            Margin="0,8,0,0"/>
                                </VerticalStackLayout>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Locked Reward (First Only) -->
                    <Label Text="Locked Reward" FontSize="16" TextColor="#888" />
                    <CollectionView ItemsSource="{Binding FourthLockedReward}" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <VerticalStackLayout Padding="10" BackgroundColor="#1E1E1E" Margin="0,0,0,10" Opacity="0.5">
                                    <Label Text="{Binding Name}" TextColor="#888" FontSize="14" FontAttributes="Bold"/>
                                    <Label Text="{Binding Description}" TextColor="#666" FontSize="12"/>
                                    <Label Text="{Binding Cost, StringFormat='Requires {0} pts'}" TextColor= "Red" FontSize="12"/>
                                    <Button Text="Locked"
                            IsEnabled="False"
                            BackgroundColor="#444"
                            TextColor="#999"
                            CornerRadius="8"
                            Margin="0,8,0,0"/>
                                </VerticalStackLayout>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                </VerticalStackLayout>

                <!-- Vehicles -->
                <Label Text="Your vehicles" FontSize="18" FontAttributes="Bold" TextColor="White" />
                <ScrollView Orientation="Horizontal">
                    <HorizontalStackLayout Spacing="12" Padding="0,8">

                        <!-- Add Vehicle Card -->
                        <Border x:Name="AddCardBorder"
                                Stroke="Gray"
                                StrokeThickness="2"
                                BackgroundColor="#1C1C1E"
                                WidthRequest="160"
                                HeightRequest="160"
                                StrokeShape="RoundRectangle 16"
                                Margin="0,0,8,0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnAddVehicleTapped" />
                            </Border.GestureRecognizers>
                            <Grid>
                                <Image Source="plus_icon.png"
                                       HeightRequest="40"
                                       WidthRequest="40"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center" />
                            </Grid>
                        </Border>

                        <!-- Vehicle Cards -->
                        <CollectionView ItemsSource="{Binding Vehicles}" ItemsLayout="HorizontalList" HeightRequest="160">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <ContentView>
                                        <ContentView.Triggers>
                                            <DataTrigger TargetType="ContentView" Binding="{Binding}" Value="{x:Null}">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </ContentView.Triggers>

                                        <!-- Actual Vehicle Card -->
                                        <views:VehicleCard>
                                            <views:VehicleCard.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnVehicleTapped" />
                                            </views:VehicleCard.GestureRecognizers>
                                        </views:VehicleCard>
                                    </ContentView>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                    </HorizontalStackLayout>
                </ScrollView>

            </VerticalStackLayout>
        </ScrollView>

        <!-- Bottom Navigation Bar -->
        <Grid Grid.Row="2"
              BackgroundColor="#1E1E1E"
              HeightRequest="70"
              Padding="10,0"
              ColumnSpacing="25">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <StackLayout Grid.Column="0" HorizontalOptions="Center" VerticalOptions="Center">
                <ImageButton Source="home_icon.png"
                             Command="{Binding GoHomeCommand}"
                             BackgroundColor="Transparent"
                             HeightRequest="28" WidthRequest="28" />
            </StackLayout>

            <StackLayout Grid.Column="1" HorizontalOptions="Center" VerticalOptions="Center">
                <ImageButton Source="calendar_icon.png"
                             Command="{Binding GoAppointmentsCommand}"
                             BackgroundColor="Transparent"
                             HeightRequest="28" WidthRequest="28" />
            </StackLayout>

            <StackLayout Grid.Column="2" HorizontalOptions="Center" VerticalOptions="Center">
                <ImageButton Source="gift_icon.png"
                             Command="{Binding GoRewardsCommand}"
                             BackgroundColor="Transparent"
                             HeightRequest="28" WidthRequest="28" />
            </StackLayout>

            <StackLayout Grid.Column="3" HorizontalOptions="Center" VerticalOptions="Center">
                <ImageButton Source="account_icon.png"
                             Command="{Binding GoAccountCommand}"
                             BackgroundColor="Transparent"
                             HeightRequest="28" WidthRequest="28" />
            </StackLayout>
        </Grid>

    </Grid>
</ContentPage>