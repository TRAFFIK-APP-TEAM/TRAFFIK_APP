<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:TRAFFIK_APP.ViewModels"
             xmlns:models="clr-namespace:TRAFFIK_APP.Models.Dtos.ServiceCatalog"
             x:Class="TRAFFIK_APP.Views.BookingServiceSelectPage"
             x:DataType="viewmodels:BookingServiceSelectViewModel"
             BackgroundColor="#0D0D0D"
             Shell.TabBarIsVisible="False"
             Title="Select Service">
    
    <ContentPage.Resources>
        <ResourceDictionary>
            <x:Boolean x:Key="True">True</x:Boolean>
            <x:Boolean x:Key="False">False</x:Boolean>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,*,Auto" Padding="0">

        <!-- Header -->
        <Grid Grid.Row="0" BackgroundColor="#1A1A1A" Padding="20,50,20,20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            
            <Button Grid.Column="0" 
                    Text="←" 
                    FontSize="24" 
                    TextColor="White" 
                    BackgroundColor="Transparent" 
                    BorderWidth="0"
                    Command="{Binding GoBackCommand}"/>
            
            <StackLayout Grid.Column="1" HorizontalOptions="Center">
                <Label Text="TRAFFIK"
                       TextColor="White"
                       FontAttributes="Bold"
                       FontSize="24"
                       HorizontalOptions="Center"/>
                <Label Text="Choose Your Service"
                       TextColor="#C8C8C8"
                       FontSize="16"
                       HorizontalOptions="Center"
                       Margin="0,5,0,0"/>
                <Label Text="{Binding SelectedVehicleDisplayName}"
                       TextColor="#007AFF"
                       FontSize="14"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       Margin="0,5,0,0"/>
            </StackLayout>
            
            <Button Grid.Column="2" 
                    Text="?" 
                    FontSize="20" 
                    TextColor="#007AFF" 
                    BackgroundColor="Transparent" 
                    BorderWidth="0"/>
        </Grid>

        <!-- Search and Filter Bar -->
        <Grid Grid.Row="1" BackgroundColor="#1A1A1A" Padding="20,0,20,20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>
            
            <!-- Search Bar -->
            <Frame Grid.Row="0" 
                   BackgroundColor="#2A2A2A" 
                   BorderColor="#404040" 
                   CornerRadius="25" 
                   Padding="20,15" 
                   Margin="0,0,0,15">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <Label Grid.Column="0" 
                           Text="🔍" 
                           FontSize="18" 
                           TextColor="#888" 
                           VerticalOptions="Center" 
                           Margin="0,0,10,0"/>
                    <Entry Grid.Column="1" 
                           Text="{Binding SearchText}"
                           Placeholder="Search services..."
                           PlaceholderColor="#666"
                           TextColor="White"
                           BackgroundColor="Transparent"/>
                    <Button Grid.Column="2" 
                            Text="✕" 
                            FontSize="16" 
                            TextColor="#888" 
                            BackgroundColor="Transparent" 
                            BorderWidth="0"
                            Command="{Binding ClearSearchCommand}"
                            IsVisible="{Binding HasSearchText}"/>
                </Grid>
            </Frame>
            
            <!-- Category Filter Chips -->
            <ScrollView Grid.Row="1" Orientation="Horizontal">
                <StackLayout Orientation="Horizontal" Spacing="10">
                    <Button Text="All"
                            Command="{Binding FilterByCategoryCommand}"
                            CommandParameter="All"
                            BackgroundColor="#007AFF"
                            TextColor="White"
                            CornerRadius="20"
                            Padding="20,10"/>
                    <Button Text="Basic Wash"
                            Command="{Binding FilterByCategoryCommand}"
                            CommandParameter="Basic"
                            BackgroundColor="#2A2A2A"
                            TextColor="#C8C8C8"
                            CornerRadius="20"
                            Padding="20,10"/>
                    <Button Text="Valet"
                            Command="{Binding FilterByCategoryCommand}"
                            CommandParameter="Valet"
                            BackgroundColor="#2A2A2A"
                            TextColor="#C8C8C8"
                            CornerRadius="20"
                            Padding="20,10"/>
                    <Button Text="Polish"
                            Command="{Binding FilterByCategoryCommand}"
                            CommandParameter="Polish"
                            BackgroundColor="#2A2A2A"
                            TextColor="#C8C8C8"
                            CornerRadius="20"
                            Padding="20,10"/>
                </StackLayout>
            </ScrollView>
        </Grid>

        <!-- Services List -->
        <RefreshView Grid.Row="2" 
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshCommand}"
                     BackgroundColor="#0D0D0D">
            <CollectionView ItemsSource="{Binding FilteredServices}"
                            BackgroundColor="Transparent"
                            SelectionMode="None">
                <CollectionView.Header>
                    <StackLayout Padding="20,10">
                        <Label Text="{Binding ServiceCount, StringFormat='{0} Services Available'}"
                               TextColor="#888"
                               FontSize="14"
                               HorizontalOptions="Center"/>
                    </StackLayout>
                </CollectionView.Header>
                
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:ServiceCatalogItem">
                        <Border BackgroundColor="#1A1A1A" 
                                Margin="20,5" 
                                Padding="0"
                                StrokeThickness="0">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="15"/>
                            </Border.StrokeShape>
                            
                            <Grid RowDefinitions="Auto,Auto,Auto,Auto" Padding="20">
                                <!-- Service Header -->
                                <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                                    <StackLayout>
                                        <Label Text="{Binding Name}"
                                               TextColor="White"
                                               FontSize="18"
                                               FontAttributes="Bold"
                                               LineBreakMode="TailTruncation"/>
                                        <Label Text="{Binding Category, StringFormat='{0} Service'}"
                                               TextColor="#007AFF"
                                               FontSize="12"
                                               FontAttributes="Bold"
                                               Margin="0,2,0,0"/>
                                    </StackLayout>
                                    <Label Grid.Column="1" 
                                           Text="{Binding Price, StringFormat='R{0:F2}'}"
                                           TextColor="#00FF88"
                                           FontSize="20"
                                           FontAttributes="Bold"
                                           VerticalOptions="Center"/>
                                </Grid>
                                
                                <!-- Description -->
                                <Label Grid.Row="1" 
                                       Text="{Binding Description}"
                                       TextColor="#C8C8C8"
                                       FontSize="14"
                                       LineBreakMode="WordWrap"
                                       Margin="0,8,0,0"/>
                                
                                <!-- Duration and Features -->
                                <Grid Grid.Row="2" ColumnDefinitions="Auto,*,Auto" Margin="0,10,0,0">
                                    <StackLayout Orientation="Horizontal" Grid.Column="0">
                                        <Label Text="⏱️" FontSize="12" TextColor="#888"/>
                                        <Label Text="{Binding EstimatedDurationMinutes, StringFormat='{0} min'}"
                                               TextColor="#888"
                                               FontSize="12"
                                               Margin="5,0,0,0"/>
                                    </StackLayout>
                                    
                                    <StackLayout Orientation="Horizontal" Grid.Column="2">
                                        <Label Text="⭐" FontSize="12" TextColor="#FFD700"/>
                                        <Label Text="4.8" TextColor="#888" FontSize="12" Margin="5,0,0,0"/>
                                    </StackLayout>
                                </Grid>
                                
                                <!-- Select Button -->
                                <Button Grid.Row="3" 
                                        Text="Select Service"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:BookingServiceSelectViewModel}}, Path=SelectServiceCommand}"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="#007AFF"
                                        TextColor="White"
                                        CornerRadius="12"
                                        FontSize="16"
                                        FontAttributes="Bold"
                                        Margin="0,15,0,0"
                                        HeightRequest="45"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                
                <CollectionView.Footer>
                    <StackLayout Padding="20,30">
                        <Label Text="Need help choosing? Contact our team for personalized recommendations."
                               TextColor="#666"
                               FontSize="14"
                               HorizontalOptions="Center"
                               HorizontalTextAlignment="Center"/>
                    </StackLayout>
                </CollectionView.Footer>
                
                <CollectionView.EmptyView>
                    <StackLayout Padding="40" HorizontalOptions="Center" VerticalOptions="Center">
                        <Label Text="No services available"
                               TextColor="#888"
                               FontSize="16"
                               HorizontalOptions="Center"/>
                        <Label Text="Pull down to refresh"
                               TextColor="#666"
                               FontSize="14"
                               HorizontalOptions="Center"
                               Margin="0,10,0,0"/>
                    </StackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </RefreshView>

        <!-- Bottom Navigation Bar -->
        <Grid Grid.Row="3"
              BackgroundColor="#1A1A1A"
              HeightRequest="80"
              Padding="20,10"
              ColumnSpacing="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <StackLayout Grid.Column="0" HorizontalOptions="Center" VerticalOptions="Center">
                <ImageButton Source="home.png"
                             Command="{Binding GoHomeCommand}"
                             BackgroundColor="Transparent"
                             HeightRequest="24" WidthRequest="24"/>
                <Label Text="Home" FontSize="11" TextColor="White" HorizontalOptions="Center" Margin="0,4,0,0"/>
            </StackLayout>

            <StackLayout Grid.Column="1" HorizontalOptions="Center" VerticalOptions="Center">
                <ImageButton Source="appointment.png"
                             Command="{Binding GoAppointmentsCommand}"
                             BackgroundColor="Transparent"
                             HeightRequest="24" WidthRequest="24"/>
                <Label Text="Book" FontSize="11" TextColor="#007AFF" HorizontalOptions="Center" Margin="0,4,0,0"/>
            </StackLayout>

            <StackLayout Grid.Column="2" HorizontalOptions="Center" VerticalOptions="Center">
                <ImageButton Source="rewards.png"
                             Command="{Binding GoRewardsCommand}"
                             BackgroundColor="Transparent"
                             HeightRequest="24" WidthRequest="24"/>
                <Label Text="Rewards" FontSize="11" TextColor="White" HorizontalOptions="Center" Margin="0,4,0,0"/>
            </StackLayout>

            <StackLayout Grid.Column="3" HorizontalOptions="Center" VerticalOptions="Center">
                <ImageButton Source="account.png"
                             Command="{Binding GoAccountCommand}"
                             BackgroundColor="Transparent"
                             HeightRequest="24" WidthRequest="24"/>
                <Label Text="Account" FontSize="11" TextColor="White" HorizontalOptions="Center" Margin="0,4,0,0"/>
            </StackLayout>
        </Grid>
    </Grid>
</ContentPage>