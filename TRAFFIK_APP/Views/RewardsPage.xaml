<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:TRAFFIK_APP.ViewModels"
             xmlns:models="clr-namespace:TRAFFIK_APP.Models.Dtos.Reward"
             xmlns:local="clr-namespace:TRAFFIK_APP.ViewModels"
             x:Class="TRAFFIK_APP.Views.RewardsPage"
             x:DataType="viewmodels:RewardsViewModel"
             BackgroundColor="#0D0D0D"
             Shell.TabBarIsVisible="False"
             Title="Rewards">

    <Grid RowDefinitions="Auto,*,Auto">

        <!-- Header -->
        <VerticalStackLayout Grid.Row="0" Padding="20" Margin="0,20,0,20">
            <Label Text="Rewards"
                   TextColor="#C8C8C8"
                   FontSize="16"
                   Margin="0,10,0,0"/>
            <Label Text="{Binding Points, StringFormat='Your Points: {0}'}"
                   TextColor="#007AFF"
                   FontSize="16"
                   FontAttributes="Bold"
                   Margin="0,10,0,0"/>
        </VerticalStackLayout>

        <!-- Content -->
        <RefreshView Grid.Row="1" Command="{Binding RefreshCommand}" IsRefreshing="{Binding IsBusy}">
            <ScrollView Padding="20">
                <VerticalStackLayout Spacing="25">

                    <!-- Available Rewards -->
                    <Label Text="Available Rewards" TextColor="White" FontSize="18" FontAttributes="Bold"/>
                    <CollectionView ItemsSource="{Binding AvailableRewards}">
                        <CollectionView.EmptyView>
                            <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Padding="20">
                                <Label Text="No available rewards" TextColor="#888" FontSize="16" HorizontalOptions="Center"/>
                                <Label Text="Earn more points to unlock rewards!" TextColor="#666" FontSize="14" HorizontalOptions="Center"/>
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:RewardItemDto">
                                <Border BackgroundColor="#1E1E1E"
                                        Stroke="#1E1E1E"
                                        StrokeThickness="0"
                                        Padding="15"
                                        Margin="0,0,0,10"
                                        StrokeShape="RoundRectangle 15">
                                    <VerticalStackLayout>
                                        <Label Text="{Binding Name, FallbackValue='Reward Name'}" TextColor="White" FontSize="16" FontAttributes="Bold"/>
                                        <Label Text="{Binding Description, FallbackValue='Reward Description'}" TextColor="#C8C8C8" FontSize="14"/>
                                        <Label Text="{Binding Cost, StringFormat='Cost: {0} pts', FallbackValue='Cost: 0 pts'}" TextColor="#007AFF" FontSize="14"/>
                                        <Button Text="Redeem Now"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:RewardsViewModel}}, Path=RedeemCommand}"
                                                CommandParameter="{Binding}"
                                                BackgroundColor="#007AFF"
                                                TextColor="White"
                                                CornerRadius="10"
                                                Margin="0,10,0,0"/>
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Locked Rewards -->
                    <Label Text="Locked Rewards" TextColor="#888" FontSize="18" FontAttributes="Bold"/>
                    <CollectionView ItemsSource="{Binding LockedRewards}">
                        <CollectionView.EmptyView>
                            <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Padding="20">
                                <Label Text="All rewards unlocked!" TextColor="#888" FontSize="16" HorizontalOptions="Center"/>
                                <Label Text="Great job earning points!" TextColor="#666" FontSize="14" HorizontalOptions="Center"/>
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:RewardItemDto">
                                <Border BackgroundColor="#1E1E1E"
                                        Stroke="#1E1E1E"
                                        StrokeThickness="0"
                                        Padding="15"
                                        Margin="0,0,0,10"
                                        StrokeShape="RoundRectangle 15"
                                        Opacity="0.5">
                                    <VerticalStackLayout>
                                        <Label Text="{Binding Name, FallbackValue='Locked Reward'}" TextColor="#888" FontSize="16" FontAttributes="Bold"/>
                                        <Label Text="{Binding Description, FallbackValue='Locked Reward Description'}" TextColor="#666" FontSize="14"/>
                                        <Label Text="{Binding Cost, StringFormat='Requires {0} pts', FallbackValue='Requires 0 pts'}" TextColor="#FF0000" FontSize="14"/>
                                        <Button Text="Locked"
                                                IsEnabled="False"
                                                BackgroundColor="#444"
                                                TextColor="#999"
                                                CornerRadius="10"
                                                Margin="0,10,0,0"/>
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Redeemed Rewards -->
                    <Label Text="My Redeemed Rewards" TextColor="White" FontSize="18" FontAttributes="Bold"/>
                    <CollectionView ItemsSource="{Binding RedeemedRewards}">
                        <CollectionView.EmptyView>
                            <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Padding="20">
                                <Label Text="No redeemed rewards yet" TextColor="#888" FontSize="16" HorizontalOptions="Center"/>
                                <Label Text="Redeem a reward to see it here!" TextColor="#666" FontSize="14" HorizontalOptions="Center"/>
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:RedeemedRewardDto">
                                <Border BackgroundColor="#1E1E1E"
                                        Stroke="#1E1E1E"
                                        StrokeThickness="0"
                                        Padding="15"
                                        Margin="0,0,0,10"
                                        StrokeShape="RoundRectangle 15">
                                    <VerticalStackLayout>
                                        <Label Text="{Binding Name}" TextColor="White" FontSize="16" FontAttributes="Bold"/>
                                        <Label Text="{Binding Description}" TextColor="#C8C8C8" FontSize="14"/>
                                        <Label Text="{Binding Cost, StringFormat='Redeemed for {0} points'}" TextColor="#888" FontSize="12"/>
                                        
                                        <!-- Redemption Code -->
                                        <Border BackgroundColor="#007AFF"
                                                Stroke="#007AFF"
                                                StrokeThickness="0"
                                                Padding="10,8"
                                                Margin="0,10,0,0"
                                                StrokeShape="RoundRectangle 8">
                                            <Grid ColumnDefinitions="*,Auto">
                                                <VerticalStackLayout Grid.Column="0">
                                                    <Label Text="Your Code" TextColor="White" FontSize="10" Opacity="0.8"/>
                                                    <Label Text="{Binding Code}" TextColor="White" FontSize="18" FontAttributes="Bold"/>
                                                </VerticalStackLayout>
                                            </Grid>
                                        </Border>
                                        
                                        <Label Text="{Binding RedeemedAt, StringFormat='Redeemed on {0:dd MMM yyyy}'}" 
                                               TextColor="#666" FontSize="12" Margin="0,10,0,0"/>
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                </VerticalStackLayout>
            </ScrollView>
        </RefreshView>
        
        

        <!-- Bottom Navigation Bar -->
        <Grid Grid.Row="2"
              BackgroundColor="#1E1E1E"
              HeightRequest="70"
              Padding="10,0"
              ColumnSpacing="25">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <StackLayout Grid.Column="0" HorizontalOptions="Center" VerticalOptions="Center">
                <ImageButton Source="home_icon.png"
                             Command="{Binding GoHomeCommand}"
                             BackgroundColor="Transparent"
                             HeightRequest="28" WidthRequest="28"/>
            </StackLayout>

            <StackLayout Grid.Column="1" HorizontalOptions="Center" VerticalOptions="Center">
                <ImageButton Source="calendar_icon.png"
                             Command="{Binding GoAppointmentsCommand}"
                             BackgroundColor="Transparent"
                             HeightRequest="28" WidthRequest="28"/>
            </StackLayout>

            <StackLayout Grid.Column="2" HorizontalOptions="Center" VerticalOptions="Center">
                <ImageButton Source="gift_icon.png"
                             Command="{Binding GoRewardsCommand}"
                             BackgroundColor="Transparent"
                             HeightRequest="28" WidthRequest="28"/>
            </StackLayout>

            <StackLayout Grid.Column="3" HorizontalOptions="Center" VerticalOptions="Center">
                <ImageButton Source="account_icon.png"
                             Command="{Binding GoAccountCommand}"
                             BackgroundColor="Transparent"
                             HeightRequest="28" WidthRequest="28"/>
            </StackLayout>
        </Grid>
    </Grid>
</ContentPage>